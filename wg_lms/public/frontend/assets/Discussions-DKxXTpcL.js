import{s as N,v as O,y as $,i as R,z as L,c as x,b2 as F,a as p,o as i,b as T,h as P,f as d,e as a,w as h,u as e,at as W,q as S,t as m,F as q,g as A,aU as H,b3 as X,b4 as Y,l as B,ai as E,n as G,a8 as I,aa as Z,L as ee,b5 as J,D as te,P as se,b6 as oe,ab as ae}from"./index-CZIp1LU6.js";import{_ as K}from"./UserAvatar-D_gN1iLa.js";const le={class:"mt-6"},ne={key:0,class:"flex items-center mb-5"},re={class:"text-lg font-semibold ml-2 text-ink-gray-9"},ie={class:"flex items-center justify-between mb-2"},de={class:"flex items-center text-ink-gray-5"},ce={class:"text-sm ml-2"},ue={key:1},pe={key:2,class:"flex justify-between mt-2"},z={__name:"DiscussionReplies",props:N({topic:{type:Object,required:!0},singleThread:{type:Boolean,default:!1}},{showTopics:{},showTopicsModifiers:{}}),emits:["update:showTopics"],setup(r){const _=O(r,"showTopics"),b=$(""),l=R("$socket"),w=R("$user"),k=R("$allUsers"),C=$([]),n=$(!1),c=window.read_only_mode,s=r;L(()=>{l.on("publish_message",t=>{v.reload()}),l.on("update_message",t=>{v.reload()}),l.on("delete_message",t=>{v.reload()}),f()});const v=x({url:"wg_lms.lms.utils.get_discussion_replies",cache:["replies",s.topic],makeParams(t){return{topic:s.topic.name}},auto:!0}),U=x({url:"frappe.client.insert",makeParams(t){return{doc:{doctype:"Discussion Reply",reply:b.value,topic:s.topic.name}}}}),f=()=>{var t;(t=w.data)!=null&&t.is_student?n.value=!0:k.reload({},{onSuccess(y){C.value=Object.values(y).map(o=>({value:o.name,label:o.full_name})),n.value=!0}})},g=()=>{U.submit({},{validate(){if(!b.value)return"Reply cannot be empty"},onSuccess(){b.value="",v.reload()},onError(t){var y;I.error(((y=t.messages)==null?void 0:y[0])||t)}})},M=x({url:"frappe.client.set_value",makeParams(t){return{doctype:"Discussion Reply",name:t.name,fieldname:"reply",value:t.reply}}}),u=t=>{M.submit({name:t.name,reply:t.reply},{validate(){if(!t.reply)return"Reply cannot be empty"},onSuccess(){t.editable=!1,v.reload()}})},V=x({url:"frappe.client.delete",makeParams(t){return{doctype:"Discussion Reply",name:t.name}}}),j=t=>{V.submit({name:t.name},{onSuccess(){v.reload()}})};return F(()=>{l.off("publish_message"),l.off("update_message"),l.off("delete_message")}),(t,y)=>(i(),p("div",le,[r.singleThread?T("",!0):(i(),p("div",ne,[d(e(S),{variant:"outline",onClick:y[0]||(y[0]=o=>_.value=!0)},{icon:h(()=>[d(e(W),{class:"w-5 h-5 stroke-1.5 text-ink-gray-7"})]),_:1}),a("span",re,m(r.topic.title),1)])),(i(!0),p(q,null,A(e(v).data,(o,Q)=>(i(),p("div",null,[a("div",{class:G(["py-3",{"border-b":Q+1!=e(v).data.length}])},[a("div",ie,[a("div",de,[d(K,{user:o.user,class:"mr-2"},null,8,["user"]),a("span",null,m(o.user.full_name),1),a("span",ce,m(e(H)(o.creation)),1)]),e(w).data.name==o.owner&&!o.editable&&!e(c)?(i(),P(e(Y),{key:0,options:[{label:t.__("Edit"),onClick(){o.editable=!0}},{label:t.__("Delete"),onClick(){j(o)}}]},{default:h(({open:D})=>[d(e(X),{class:"w-4 h-4 stroke-1.5 cursor-pointer"})]),_:1},8,["options"])):T("",!0),o.editable?(i(),p("div",ue,[d(e(S),{variant:"ghost",onClick:D=>u(o)},{default:h(()=>[B(m(t.__("Post")),1)]),_:1},8,["onClick"]),d(e(S),{variant:"ghost",onClick:D=>o.editable=!1},{default:h(()=>[B(m(t.__("Discard")),1)]),_:1},8,["onClick"])])):T("",!0)]),d(e(E),{content:o.reply,onChange:D=>o.reply=D,editable:o.editable||!1,fixedMenu:o.editable||!1,editorClass:o.editable?"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none":"prose-sm"},null,8,["content","onChange","editable","fixedMenu","editorClass"])],2)]))),256)),n.value&&!e(c)?(i(),P(e(E),{key:1,class:"mt-5",content:b.value,mentions:C.value,onChange:y[1]||(y[1]=o=>b.value=o),placeholder:"Type your reply here...",fixedMenu:!0,editorClass:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none border border-outline-gray-2 rounded-b-md min-h-[7rem] py-1 px-2"},null,8,["content","mentions"])):T("",!0),e(c)?T("",!0):(i(),p("div",pe,[y[3]||(y[3]=a("span",null,null,-1)),d(e(S),{onClick:y[2]||(y[2]=o=>g())},{default:h(()=>[a("span",null,m(t.__("Post")),1)]),_:1})]))]))}},me={class:"flex flex-col gap-4"},fe={class:"mb-1.5 text-sm text-ink-gray-5"},ye={__name:"DiscussionModal",props:N({title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0}},{reloadTopics:{},reloadTopicsModifiers:{}}),emits:["update:reloadTopics"],setup(r){const _=O(r,"reloadTopics"),b=r,l=Z({title:"",reply:""}),w=x({url:"frappe.client.insert",makeParams(n){return{doc:{doctype:"Discussion Topic",reference_doctype:b.doctype,reference_docname:b.docname,title:l.title}}}}),k=x({url:"frappe.client.insert",makeParams(n){return{doc:{doctype:"Discussion Reply",topic:n.topic,reply:l.reply}}}}),C=n=>{w.submit({},{validate(){if(!l.title)return"Title cannot be empty.";if(!l.reply)return"Reply cannot be empty."},onSuccess(c){k.submit({topic:c.name},{onSuccess(){l.title="",l.reply="",_.value.reload(),n()}})},onError(c){var s;I.error(((s=c.messages)==null?void 0:s[0])||c)}})};return(n,c)=>(i(),P(e(te),{options:{title:e(J)(b.title),size:"2xl",actions:[{label:"Post",variant:"solid",onClick:s=>C(s)}]}},{"body-content":h(()=>[a("div",me,[a("div",null,[d(e(ee),{modelValue:l.title,"onUpdate:modelValue":c[0]||(c[0]=s=>l.title=s),label:n.__("Title"),type:"text"},null,8,["modelValue","label"])]),a("div",null,[a("div",fe,m(n.__("Details")),1),d(e(E),{content:l.reply,onChange:c[1]||(c[1]=s=>l.reply=s),editable:!0,fixedMenu:!0,editorClass:"prose-sm max-w-none border-b border-x bg-surface-gray-2 rounded-b-md py-1 px-2 min-h-[7rem]"},null,8,["content"])])])]),_:1},8,["options"]))}};function be(){return window.scrollContainer}const ve={class:"text-xl font-semibold text-ink-gray-9"},ge={key:0},_e=["onClick"],he={class:"text-lg font-semibold mb-1 text-ink-gray-7"},ke={class:"flex items-center text-ink-gray-5"},Te={class:"text-sm ml-3"},xe={key:1},we={key:1},Ce={key:2,class:"flex flex-col items-center justify-center border-2 border-dashed mt-5 py-8 rounded-md"},$e={class:"mt-2"},Se={key:0,class:"font-medium mb-2"},Re={class:"text-ink-gray-5"},Pe={__name:"Discussions",props:{title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0},emptyStateTitle:{type:String,default:""},emptyStateText:{type:String,default:"Start a Discussion"},singleThread:{type:Boolean,default:!1},scrollToBottom:{type:Boolean,default:!1}},setup(r){const _=$(!0),b=$(null),l=R("$socket"),w=R("$user"),k=$(!1),C=window.read_only_mode,n=r;L(()=>{w.data&&s.reload(),l.on("new_discussion_topic",f=>{s.refresh()}),n.scrollToBottom&&setTimeout(()=>{c()},100)});const c=()=>{let f=be();f.scrollTop=f.scrollHeight},s=x({url:"wg_lms.lms.utils.get_discussion_topics",cache:["topics",n.doctype,n.docname],makeParams(){return{doctype:n.doctype,docname:n.docname,single_thread:n.singleThread}}}),v=f=>{_.value=!1,b.value=f},U=()=>{k.value=!0};return F(()=>{l.off("new_discussion_topic")}),(f,g)=>{var M;return i(),p(q,null,[a("div",null,[!r.singleThread&&!e(C)?(i(),P(e(S),{key:0,class:"float-right",onClick:g[0]||(g[0]=u=>U())},{prefix:h(()=>[d(e(se),{class:"size-4"})]),default:h(()=>[B(" "+m(f.__("New {0}").format(e(J)(r.title))),1)]),_:1})):T("",!0),a("div",ve,m(f.__(r.title)),1)]),(M=e(s).data)!=null&&M.length&&!r.singleThread?(i(),p("div",ge,[_.value?(i(!0),p(q,{key:0},A(e(s).data,(u,V)=>(i(),p("div",null,[a("div",{onClick:j=>v(u),class:G(["flex items-center cursor-pointer py-5 w-full",{"border-b":V+1!=e(s).data.length}])},[d(K,{user:u.user,size:"2xl",class:"mr-4"},null,8,["user"]),a("div",null,[a("div",he,m(u.title),1),a("div",ke,[a("span",null,m(u.user.full_name),1),a("span",Te,m(e(H)(u.creation)),1)])])],10,_e)]))),256)):(i(),p("div",xe,[d(z,{topic:b.value,showTopics:_.value,"onUpdate:showTopics":g[1]||(g[1]=u=>_.value=u)},null,8,["topic","showTopics"])]))])):r.singleThread&&e(s).data?(i(),p("div",we,[d(z,{topic:e(s).data,singleThread:r.singleThread},null,8,["topic","singleThread"])])):(i(),p("div",Ce,[d(e(oe),{class:"w-7 h-7 text-ink-gray-4 stroke-1.5 mr-2"}),a("div",$e,[r.emptyStateTitle?(i(),p("div",Se,m(f.__(r.emptyStateTitle)),1)):T("",!0),a("div",Re,m(f.__(r.emptyStateText)),1)])])),d(ye,{modelValue:k.value,"onUpdate:modelValue":g[2]||(g[2]=u=>k.value=u),title:f.__("New {0}").format(r.title),doctype:n.doctype,docname:n.docname,reloadTopics:e(s),"onUpdate:reloadTopics":g[3]||(g[3]=u=>ae(s)?s.value=u:null)},null,8,["modelValue","title","doctype","docname","reloadTopics"])],64)}}};export{Pe as _};
//# sourceMappingURL=Discussions-DKxXTpcL.js.map
